%% matrix init

C=[ 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0; 
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
    0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
    0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
    0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1;];

G=[ 4,-1,-1,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
   -1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0;
   -1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0;
   -1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0;
    0, 0, 0, 0, 2,-1, 0,-1, 0, 0, 0, 0, 0,-1, 0, 0, 0, 0, 0;
    0, 0, 0, 0,-1, 3,-1, 0,-1, 0, 0, 0, 0, 0,-1, 0, 0, 0, 0;
    0, 0, 0, 0, 0,-1, 2, 0, 0,-1, 0, 0, 0, 0, 0,-1, 0, 0, 0;
    0, 0, 0, 0,-1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0;
    0, 0, 0, 0, 0,-1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0;
    0, 0, 0, 0, 0, 0,-1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1;
    0, 0, 0, 0, 0, 0, 0, 0, 0, 1,-1, 0, 0, 0, 0, 0,-1, 0, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 0,-1, 3,-1, 0, 0, 0, 0, 0,-1, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-1, 1, 0, 0, 0, 0, 0, 0,-1;
    0,-1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
    0, 0,-1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
    0, 0, 0,-1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
    0, 0, 0, 0, 0, 0, 0,-1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0;
    0, 0, 0, 0, 0, 0, 0, 0,-1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 0,-1, 0, 0, 1, 0, 0, 0, 0, 0, 0;];

B=[1; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0; 0];


u = 5;

%% backward eular

delta_t = 0.1;
timestep = 0: delta_t: 5;
timestep_len = length(timestep);
eular_result = zeros(timestep_len, 1);

v_next = zeros(19, 1);
for i = 2: timestep_len
    v_next = (G + C / delta_t) \ (C * v_next / delta_t + B * u);
    eular_result(i) = v_next(6);
end

figure;  % 建議明確開新圖
ax1 = subplot(2, 1, 1);
plot(ax1, timestep, eular_result, 'LineWidth', 1.5);
grid(ax1, 'on');
title(ax1, "backward eular");
xlabel(ax1, "time (s)");
ylabel(ax1, "voltage (v)");


%% moment matching

syms s t;

m0 = inv(G) * B * u / s;
m1 = - inv(G) * C * m0;
m2 = - inv(G) * C * m1;
m3 = - inv(G) * C * m2;

sys = (m0 + m1 * s + m2 * s^2 + m3 * s^3);

node_middle = sys(6);

node_middlex = pade(node_middle, s, 'Order', [0, 3]);

disp(node_middlex);

inv_lap = ilaplace(node_middlex, s, t);

% --- numeric evaluation on the same timestep grid ---
v_mm_sym = inv_lap;                     % symbolic v6(t)
v_mm = double(subs(v_mm_sym, t, timestep));  % evaluate at timestep (0:dt:5)
v_mm = real(v_mm(:));                   % make it a real column vector (safety)

% --- plot (moment matching) ---
ax2 = subplot(2, 1, 2);
plot(ax2, timestep, v_mm, 'LineWidth', 1.5);
grid(ax2, 'on');
title(ax2, "moment matching");
xlabel(ax2, "time (s)");
ylabel(ax2, "voltage (v)");